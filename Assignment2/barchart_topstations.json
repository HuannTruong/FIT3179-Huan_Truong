{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "title": {
    "text": "Top 10 Melbourne Train Stations",
    "anchor": "start",
    "fontSize": 20,
    "fontWeight": "bold"
  },
  "width": 1000,
  "height": 420,

  "data": { "url": "data/annual_metropolitan_train_station_entries_fy_2024_2025.csv" },

  "params": [
    {
      "name": "metricSel",
      "value": "Both (AM vs PM)",
      "bind": {
        "input": "select",
        "name": "Metric: ",
        "options": ["Both (AM vs PM)", "Total", "AM only", "PM only"]
      }
    }
  ],

  "transform": [
    { "calculate": "toNumber(datum.Pax_annual)", "as": "p_total" },
    { "calculate": "toNumber(datum.Pax_AM_peak)", "as": "p_am" },
    { "calculate": "toNumber(datum.Pax_PM_peak)", "as": "p_pm" },
    {
      "window": [{"op": "rank", "as": "rank"}],
      "sort": [{"field": "p_total", "order": "descending"}]
    },
    { "filter": "datum.rank <= 10" }
  ],

  "layer": [
    {
      "transform": [
        { "filter": "metricSel == 'Both (AM vs PM)'" },
        { "fold": ["p_am", "p_pm"], "as": ["Period_raw", "Passengers"] },
        { "calculate": "datum.Period_raw == 'p_am' ? 'AM Peak' : 'PM Peak'", "as": "series" }
      ],
      "mark": { "type": "bar", "cornerRadiusEnd": 2 },
      "encoding": {
        "x": {
          "field": "Stop_name",
          "type": "nominal",
          "title": "Station",
          "sort": { "field": "p_total", "order": "descending" },
          "axis": { "labelAngle": -30 }
        },
        "y": {
          "field": "Passengers",
          "type": "quantitative",
          "title": "Passengers",
          "axis": { "format": "~s" }
        },
        "xOffset": { "field": "series" },
        "color": {
          "field": "series",
          "type": "nominal",
          "title": "Metric",
          "scale": {
            "domain": ["AM Peak", "PM Peak", "Total"],
            "range": ["#2b83ba", "#d53e4f", "#1b9e77"]
          },
          "legend": { "orient": "top", "direction": "horizontal", "labelFontSize": 12, "titleFontSize": 14 }
        },
        "tooltip": [
          { "field": "Stop_name", "title": "Station" },
          { "field": "p_total", "title": "Annual", "format": "," },
          { "field": "p_am", "title": "AM peak", "format": "," },
          { "field": "p_pm", "title": "PM peak", "format": "," }
        ]
      }
    },

    {
      "transform": [
        { "filter": "metricSel == 'Total'" },
        { "calculate": "'Total'", "as": "series" }
      ],
      "mark": { "type": "bar", "cornerRadiusEnd": 2 },
      "encoding": {
        "x": {
          "field": "Stop_name",
          "type": "nominal",
          "title": "Station",
          "sort": { "field": "p_total", "order": "descending" },
          "axis": { "labelAngle": -30 }
        },
        "y": {
          "field": "p_total",
          "type": "quantitative",
          "title": "Passengers",
          "axis": { "format": "~s" }
        },
        "color": {
          "field": "series",
          "type": "nominal",
          "title": "Metric",
          "scale": {
            "domain": ["AM Peak", "PM Peak", "Total"],
            "range": ["#2b83ba", "#d53e4f", "#1b9e77"]
          },
          "legend": { "orient": "top", "direction": "horizontal" }
        },
        "tooltip": [
          { "field": "Stop_name", "title": "Station" },
          { "field": "p_total", "title": "Annual", "format": "," },
          { "field": "p_am", "title": "AM peak", "format": "," },
          { "field": "p_pm", "title": "PM peak", "format": "," }
        ]
      }
    },

    {
      "transform": [
        { "filter": "metricSel == 'AM only'" },
        { "calculate": "'AM Peak'", "as": "series" }
      ],
      "mark": { "type": "bar", "cornerRadiusEnd": 2 },
      "encoding": {
        "x": {
          "field": "Stop_name",
          "type": "nominal",
          "title": "Station",
          "sort": { "field": "p_total", "order": "descending" },
          "axis": { "labelAngle": -30 }
        },
        "y": {
          "field": "p_am",
          "type": "quantitative",
          "title": "Passengers",
          "axis": { "format": "~s" }
        },
        "color": {
          "field": "series",
          "type": "nominal",
          "title": "Metric",
          "scale": {
            "domain": ["AM Peak", "PM Peak", "Total"],
            "range": ["#2b83ba", "#d53e4f", "#1b9e77"]
          },
          "legend": { "orient": "top", "direction": "horizontal" }
        },
        "tooltip": [
          { "field": "Stop_name", "title": "Station" },
          { "field": "p_total", "title": "Annual", "format": "," },
          { "field": "p_am", "title": "AM peak", "format": "," },
          { "field": "p_pm", "title": "PM peak", "format": "," }
        ]
      }
    },

    {
      "transform": [
        { "filter": "metricSel == 'PM only'" },
        { "calculate": "'PM Peak'", "as": "series" }
      ],
      "mark": { "type": "bar", "cornerRadiusEnd": 2 },
      "encoding": {
        "x": {
          "field": "Stop_name",
          "type": "nominal",
          "title": "Station",
          "sort": { "field": "p_total", "order": "descending" },
          "axis": { "labelAngle": -30 }
        },
        "y": {
          "field": "p_pm",
          "type": "quantitative",
          "title": "Passengers",
          "axis": { "format": "~s" }
        },
        "color": {
          "field": "series",
          "type": "nominal",
          "title": "Metric",
          "scale": {
            "domain": ["AM Peak", "PM Peak", "Total"],
            "range": ["#2b83ba", "#d53e4f", "#1b9e77"]
          },
          "legend": { "orient": "top", "direction": "horizontal" }
        },
        "tooltip": [
          { "field": "Stop_name", "title": "Station" },
          { "field": "p_total", "title": "Annual", "format": "," },
          { "field": "p_am", "title": "AM peak", "format": "," },
          { "field": "p_pm", "title": "PM peak", "format": "," }
        ]
      }
    }
  ],

  "config": {
    "axis": { "labelFontSize": 12, "titleFontSize": 14 },
    "view": { "stroke": "transparent" }
  }
}
