{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "title": {
    "text": "Passenger Volume vs Nearby Restaurants",
    "subtitle": "Annual passengers (log) vs count of nearby restaurants",
    "anchor": "start",
    "fontSize": 20,
    "fontWeight": "bold"
  },
  "width": "container",
  "height": 420,

  "data": { "url": "./data/restaurants_with_nearest_station.csv" },

  "params": [
    {
      "name": "excludeLoop",
      "value": false,
      "bind": {
        "input": "select",
        "options": [false, true],
        "labels": ["All Stations", "Exclude City Loop Stations"],
        "name": "Filter: "
      }
    }
  ],

  "transform": [
    { "calculate": "datum.priceLevel=='$'?1 : datum.priceLevel=='$$ - $$$'?2.5 : datum.priceLevel=='$$$$'?4 : null", "as": "price_num" },
    { "filter": "isFinite(datum.price_num)" },

    {
      "aggregate": [
        {"op": "count", "as": "rest_count"},
        {"op": "mean",  "field": "price_num", "as": "avg_price_num"}
      ],
      "groupby": ["nearest_station_name"]
    },

    { "calculate": "datum.avg_price_num <= 1.5 ? '$' : (datum.avg_price_num <= 3 ? '$$ - $$$' : '$$$$')", "as": "price_band" },

    {
      "lookup": "nearest_station_name",
      "from": {
        "data": { "url": "./data/annual_metropolitan_train_station_entries_fy_2024_2025.csv" },
        "key": "Stop_name",
        "fields": ["Pax_annual"]
      }
    },

    { "calculate": "toNumber(datum.Pax_annual)", "as": "pax" },
    { "filter": "isFinite(datum.pax) && datum.pax > 0" },
    
    { "calculate": "indexof(['Flinders Street','Southern Cross','Flagstaff','Melbourne Central','Parliament'], datum.nearest_station_name) >= 0", "as": "isLoopStation" },
    
    { "filter": "!excludeLoop || indexof(['Flinders Street','Southern Cross','Flagstaff','Melbourne Central','Parliament'], datum.nearest_station_name) < 0" }
  ],
  "layer": [
  {
    "mark": {
      "type": "point",
      "filled": true,
      "size": 90,
      "opacity": 0.85,
      "stroke": "white",
      "strokeWidth": 0.7
    },
    "encoding": {
      "x": {
        "field": "pax",
        "type": "quantitative",
        "title": "Annual passengers (log)",
        "scale": { "type": "log", "domainMin": 10000 },
        "axis": { "format": "~s", "grid": false }
      },
      "y": {
        "field": "rest_count",
        "type": "quantitative",
        "title": "Number of nearby restaurants",
        "scale": { "nice": true, "zero": true },
        "axis": { "grid": true }
      },
      "color": {
        "field": "price_band",
        "type": "nominal",
        "title": "Typical price level",
        "scale": {
          "domain": ["$", "$$ - $$$", "$$$$"],
          "range": ["#66bd63", "#fdae61", "#d73027"]
        },
        "legend": {
          "orient": "top",
          "direction": "horizontal",
          "titleAnchor": "start",
          "offset": 10
        }
      },
      "tooltip": [
        { "field": "nearest_station_name", "title": "Station" },
        { "field": "pax", "title": "Annual passengers", "format": "," },
        { "field": "rest_count", "title": "Nearby restaurants" },
        { "field": "avg_price_num", "title": "Avg price (1â€“4)", "format": ".1f" },
        { "field": "price_band", "title": "Price band" },
        { "field": "isLoopStation", "title": "City Loop Station" }
      ]
    }
  }
],


  "config": {
    "view": { "stroke": null },
    "axis": { "labelFontSize": 11, "titleFontSize": 12 },
    "legend": {
      "labelFontSize": 11,
      "titleFontSize": 12,
      "columns": 3,
      "columnPadding": 10
    }
  }
}
